---
- name: Install Docker from Artifact Repository
  hosts: all
  become: true
  gather_facts: true

  vars_files:
    - vars/docker_artifact_vars.yml

  vars:
    docker_rpm_dir: /tmp/docker_rpms

    docker_rpms:
      - docker-ce-28.1.1-1.el8.x86_64.rpm
      - docker-ce-cli-28.1.1-1.el8.x86_64.rpm
      - docker-compose-plugin-2.26.1-1.el8.x86_64.rpm
      - docker-buildx-plugin-0.14.1-1.el8.x86_64.rpm
      - containerd.io-1.6.33-3.1.el8.x86_64.rpm

  tasks:
    - name: Create temp dir for Docker RPMs
      ansible.builtin.file:
        path: "{{ docker_rpm_dir }}"
        state: directory
        mode: "0755"

    - name: Download Docker RPMs from artifact repo
      ansible.builtin.get_url:
        url: "{{ ARTIFACT_INPUT }}/{{ SOURCE_DOCKER_PATH_INPUT }}/{{ item }}"
        dest: "{{ docker_rpm_dir }}/{{ item }}"
        mode: "0644"
        url_username: "{{ USER_INPUT }}"
        url_password: "{{ PWD_INPUT }}"
        force: true
      loop: "{{ docker_rpms }}"
      no_log: true

    - name: Stop Docker if running (do not fail if not installed)
      ansible.builtin.service:
        name: docker
        state: stopped
      failed_when: false

    - name: Install Docker RPMs via dnf (local files)
      ansible.builtin.dnf:
        name: "{{ docker_rpms | map('regex_replace', '^(.*)$', docker_rpm_dir ~ '/\\1') | list }}"
        state: present
        disable_gpg_check: true

    - name: Enable and start Docker
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true

    - name: Verify Docker version
      ansible.builtin.command: docker --version
      register: docker_version
      changed_when: false

    - name: Show Docker version
      ansible.builtin.debug:
        msg: "{{ docker_version.stdout }}"

vars/docker_artifact_vars.yml

ARTIFACT_INPUT: "https://your-artifact-host/artifactory"
SOURCE_DOCKER_PATH_INPUT: "path/to/docker/rpms"
USER_INPUT: "your_user"
PWD_INPUT: "your_password"



---
- name: Deploy OpenShift oc client from Artifact Repository
  hosts: all
  become: true
  gather_facts: true

  vars_files:
    - vars/oc_artifact_vars.yml

  vars:
    oc_install_dir: /usr/bin
    oc_target_path: "{{ oc_install_dir }}/oc"
    oc_versioned_path: "{{ oc_install_dir }}/oc-{{ OC_VERSION | default('unknown') }}"
    oc_download_dest: "/tmp/oc"

  tasks:
    - name: Download oc binary from artifact repo
      ansible.builtin.get_url:
        url: "{{ ARTIFACT_BASE_URL }}/{{ OC_ARTIFACT_PATH }}"
        dest: "{{ oc_download_dest }}"
        mode: "0755"
        url_username: "{{ ARTIFACT_USER }}"
        url_password: "{{ ARTIFACT_PASSWORD }}"
        force: true
      no_log: true

    - name: Install oc as versioned binary (atomic move)
      ansible.builtin.copy:
        src: "{{ oc_download_dest }}"
        dest: "{{ oc_versioned_path }}"
        remote_src: true
        owner: root
        group: root
        mode: "0755"

    - name: Create/Update symlink /usr/bin/oc -> versioned oc
      ansible.builtin.file:
        src: "{{ oc_versioned_path }}"
        dest: "{{ oc_target_path }}"
        state: link
        force: true

    - name: Verify oc is installed
      ansible.builtin.command: "{{ oc_target_path }} version --client"
      register: oc_client_version
      changed_when: false
      failed_when: false

    - name: Show oc client version
      ansible.builtin.debug:
        msg: "{{ oc_client_version.stdout | default('oc installed, but version check did not return output') }}"



---
# Base URL (no trailing slash)
ARTIFACT_BASE_URL: "https://www.artifactrepository.citigroup.net:443/artifactory"

# Path inside artifactory repo to the oc binary
# Example from your screenshot: generic-cto-dev-local/cate-bigdata-165345/oc/oc
OC_ARTIFACT_PATH: "generic-cto-dev-local/cate-bigdata-165345/oc/oc"

# Optional version label (used only for naming /usr/bin/oc-<version>)
OC_VERSION: "4.14.0"

# Credentials
ARTIFACT_USER: "bd_artifactory_read"
ARTIFACT_PASSWORD: "CHANGE_ME"

